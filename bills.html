<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bills | Billing App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- HEADER -->
<header class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
  <div id="shopName" class="text-lg font-semibold">
    Kirana Store
  </div>

  <nav class="flex gap-4 items-center">
    <a href="products.html" class="hover:underline">Products</a>
    <a href="reports.html" class="hover:underline">Reports</a>

    <button
      id="logoutBtn"
      type="button"
      class="bg-red-500 hover:bg-red-600 px-4 py-1 rounded"
    >
      Logout
    </button>
  </nav>
</header>

<!-- MAIN -->
<main class="p-4 max-w-5xl mx-auto">

  <!-- CREATE BILL -->
  <div class="bg-white shadow rounded p-4 mb-6">
    <h2 class="text-lg font-semibold mb-4">Create New Bill</h2>

    <!-- VOICE -->
    <div class="flex items-center gap-3 mb-4">
      <button
        id="voiceBtn"
        type="button"
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded"
      >
        ðŸŽ¤ Start Voice
      </button>
      <span id="voiceStatus" class="text-sm text-gray-600"></span>
    </div>

    <!-- PRODUCTS TABLE (SCROLLABLE â€“ MOBILE FRIENDLY) -->
    <div class="overflow-y-auto border rounded" style="max-height:300px;">
      <table class="w-full border text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="border p-2">Product</th>
            <th class="border p-2">Price</th>
            <th class="border p-2">Stock</th>
            <th class="border p-2">Qty</th>
            <th class="border p-2">Total</th>
          </tr>
        </thead>
        <tbody id="productsTableBody"></tbody>
      </table>
    </div>
  </div>

</main>

<!-- FIXED BOTTOM BAR -->
<div class="sticky bottom-0 bg-white border-t p-4 flex justify-between items-center">
  <div class="font-semibold text-sm">
    Items: <span id="totalItems">0</span> |
    â‚¹ <span id="grandTotal">0</span>
  </div>

  <div class="flex gap-3">
    <button
      id="createBillBtn"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
    >
      Create Bill
    </button>

    <button
      id="refreshBillBtn"
      class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded"
    >
      ðŸ”„ New Bill
    </button>
  </div>
</div>

<!-- CONFIG -->
<script src="/js/config.js"></script>

<!-- BILLS LOGIC -->
<script src="/js/bills.js"></script>

<!-- ================= VOICE LOGIC (PRODUCT STYLE â€“ FINAL) ================= -->
<script>
(function () {
  const voiceBtn = document.getElementById("voiceBtn");
  const statusEl = document.getElementById("voiceStatus");

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    statusEl.textContent = "Voice not supported";
    return;
  }

  const rec = new SR();
  rec.lang = "en-IN";
  rec.continuous = false;

  let isListening = false;
  let manuallyStopped = false;

  voiceBtn.onclick = () => {
    if (!isListening) {
      manuallyStopped = false;
      isListening = true;
      voiceBtn.textContent = "â¹ Stop Voice";
      statusEl.textContent = "ðŸŽ¤ Listening...";
      rec.start();
    } else {
      manuallyStopped = true;
      isListening = false;
      voiceBtn.textContent = "ðŸŽ¤ Start Voice";
      statusEl.textContent = "Voice stopped";
      rec.stop();
    }
  };

  // ðŸ”¥ UPDATED RESULT HANDLER (AUTO ADD QTY)
  rec.onresult = e => {
    const text = e.results[0][0].transcript.toLowerCase();
    statusEl.textContent = `Heard: "${text}"`;

    document.querySelectorAll("#productsTableBody tr").forEach(row => {
      const productName = row.children[0].innerText.toLowerCase();

      if (text.includes(productName)) {
        const qtyMatch = text.match(/\d+/);
        if (!qtyMatch) return;

        const qtyInput = row.querySelector(".qtyInput");
        const currentQty = Number(qtyInput.value) || 0;
        const spokenQty = Number(qtyMatch[0]);

        // âœ… AUTO ADD (INCREMENT)
        qtyInput.value = currentQty + spokenQty;
        qtyInput.dispatchEvent(new Event("input")); // updates total + items
      }
    });
  };

  // ðŸ” KEEP LISTENING UNTIL USER STOPS
  rec.onend = () => {
    if (!manuallyStopped && isListening) {
      rec.start();
    }
  };
})();
</script>

</body>
</html>
